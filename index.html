<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Agendamento - Professores</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ✅ Substitua pela SUA URL do Apps Script
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzEsOINnFdDFryoOTg6HAp-fWMgc8BoPEbrmHxb4jjrMW7g-DIci29k6jX3vtVPR_k/exec";

    // 🔹 Estrutura de matérias e professores
    const subjects = {
      "Língua Portuguesa e Redação": {
        icon: "📚",
        color: "blue",
        teachers: [
          { id: 1, name: "Profª. Juliana Tricot" },
          { id: 2, name: "Profª. Juliana Velho" },
          { id: 3, name: "Profª. Daniella" },
          { id: 4, name: "Profª. Márcia" }
        ]
      },
      "Matemática": {
        icon: "🧮",
        color: "green",
        teachers: [
          { id: 5, name: "Profª. Aline" },
          { id: 6, name: "Profª Eliana" },
          { id: 7, name: "Profª Kátya" },
          { id: 8, name: "Prof. Mateus" },
          { id: 9, name: "Profª Michele" }
        ]
      }
      // ➕ Você pode continuar listando as demais matérias e professores aqui
    };

    // 🔹 Horários fixos (18h30 até 19h50, a cada 10 minutos)
    function gerarHorarios() {
      const slots = [];
      let h = 18, m = 30;
      while (h < 19 || (h === 19 && m <= 50)) {
        const hh = String(h).padStart(2, "0");
        const mm = String(m).padStart(2, "0");
        slots.push(`${hh}:${mm}`);
        m += 10;
        if (m >= 60) { h++; m = 0; }
      }
      return slots;
    }
    const HORARIOS = gerarHorarios();

    function App() {
      const [screen, setScreen] = useState("home"); // home → subjects → teachers → booking
      const [agendamentos, setAgendamentos] = useState([]);
      const [selectedSubject, setSelectedSubject] = useState(null);
      const [selectedTeacher, setSelectedTeacher] = useState(null);
      const [form, setForm] = useState({
        parentName: "",
        studentName: "",
        email: "",
        time: "",
        bookingDate: new Date().toLocaleDateString("pt-BR")
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");

      // 🔹 Carregar agendamentos existentes
      async function loadAgendamentos() {
        try {
          setLoading(true);
          const response = await fetch(APPS_SCRIPT_URL);
          const data = await response.json();
          if (data.success) {
            setAgendamentos(data.data);
          } else {
            setError("Erro ao carregar dados: " + data.error);
          }
        } catch (err) {
          console.error("Erro no fetch:", err);
          setError("Falha de conexão com o servidor.");
        } finally {
          setLoading(false);
        }
      }

      // 🔹 Salvar novo agendamento
      async function salvarAgendamento(e) {
        e.preventDefault();
        try {
          setLoading(true);
          const booking = {
            teacher: selectedTeacher.name,
            subject: selectedSubject,
            ...form
          };
          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(booking)
          });
          const data = await response.json();
          if (data.success) {
            alert("✅ Agendamento salvo com sucesso!");
            setScreen("home");
            loadAgendamentos();
          } else {
            alert("⚠️ Erro: " + data.error);
          }
        } catch (err) {
          console.error("Erro no POST:", err);
          alert("❌ Falha ao salvar agendamento.");
        } finally {
          setLoading(false);
        }
      }

      useEffect(() => {
        loadAgendamentos();
      }, []);

      // 🔹 Verifica horários já ocupados para o professor selecionado
      function horariosOcupados() {
        if (!selectedTeacher) return [];
        return agendamentos
          .slice(1) // ignora cabeçalho
          .filter(row => row[0] === selectedTeacher.name)
          .map(row => row[5]);
      }
      const ocupados = horariosOcupados();

      // 🔹 Renderização de telas
      if (screen === "home") {
        return (
          <div className="max-w-4xl mx-auto p-6 text-center">
            <h1 className="text-3xl font-bold mb-6">📅 Sistema de Agendamento</h1>
            <button
              onClick={() => setScreen("subjects")}
              className="px-6 py-3 bg-indigo-600 text-white rounded-lg"
            >
              Começar Agendamento
            </button>
          </div>
        );
      }

      if (screen === "subjects") {
        return (
          <div className="max-w-5xl mx-auto p-6">
            <h2 className="text-2xl font-bold mb-6 text-center">Selecione a Matéria</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
              {Object.entries(subjects).map(([subject, data]) => (
                <button
                  key={subject}
                  onClick={() => { setSelectedSubject(subject); setScreen("teachers"); }}
                  className="bg-white rounded-xl shadow p-6 hover:shadow-lg"
                >
                  <div className="text-4xl mb-2">{data.icon}</div>
                  <div className="font-semibold">{subject}</div>
                  <div className="text-sm text-gray-500">{data.teachers.length} professores</div>
                </button>
              ))}
            </div>
          </div>
        );
      }

      if (screen === "teachers") {
        const teachers = subjects[selectedSubject]?.teachers || [];
        return (
          <div className="max-w-4xl mx-auto p-6">
            <h2 className="text-2xl font-bold mb-6 text-center">{selectedSubject}</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
              {teachers.map(t => (
                <div key={t.id} className="bg-white rounded-xl shadow p-6">
                  <h3 className="text-lg font-semibold mb-2">{t.name}</h3>
                  <button
                    onClick={() => { setSelectedTeacher(t); setScreen("booking"); }}
                    className="w-full py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                  >
                    Agendar
                  </button>
                </div>
              ))}
            </div>
          </div>
        );
      }

      if (screen === "booking") {
        return (
          <div className="max-w-2xl mx-auto p-6">
            <h2 className="text-2xl font-bold mb-6 text-center">Agendar com {selectedTeacher.name}</h2>
            <form onSubmit={salvarAgendamento} className="bg-white p-6 rounded-lg shadow">
              <input
                className="w-full p-2 border rounded mb-3"
                placeholder="Nome do Responsável"
                value={form.parentName}
                onChange={e => setForm({ ...form, parentName: e.target.value })}
                required
              />
              <input
                className="w-full p-2 border rounded mb-3"
                placeholder="Nome do Estudante"
                value={form.studentName}
                onChange={e => setForm({ ...form, studentName: e.target.value })}
                required
              />
              <input
                className="w-full p-2 border rounded mb-3"
                type="email"
                placeholder="Email"
                value={form.email}
                onChange={e => setForm({ ...form, email: e.target.value })}
                required
              />

              <label className="block font-medium mb-2">Horário</label>
              <select
                className="w-full p-2 border rounded mb-4"
                value={form.time}
                onChange={e => setForm({ ...form, time: e.target.value })}
                required
              >
                <option value="">-- selecione --</option>
                {HORARIOS.map(h => (
                  <option key={h} value={h} disabled={ocupados.includes(h)}>
                    {h} {ocupados.includes(h) ? " (indisponível)" : ""}
                  </option>
                ))}
              </select>

              <button
                type="submit"
                className="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700"
                disabled={loading}
              >
                {loading ? "Salvando..." : "Confirmar Agendamento"}
              </button>
            </form>
          </div>
        );
      }

      return <p className="text-center">Erro: tela desconhecida</p>;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
