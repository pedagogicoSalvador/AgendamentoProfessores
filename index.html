<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento - Professores</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBT3t4rEssF3V53ocaL-7-bEvleAhX5W_EjrvTLqDdk4yhFX1HUeOhRya__Y8SAONbNA/exec';

        function TeacherSchedulingSystem() {
          // SLOTS SIMPLIFICADOS - 9 horários de 10 minutos (18:30 às 19:50)
          const TIME_SLOTS = [
            { id: 'A', time: '18:30', label: 'A - 18:30' },
            { id: 'B', time: '18:40', label: 'B - 18:40' },
            { id: 'C', time: '18:50', label: 'C - 18:50' },
            { id: 'D', time: '19:00', label: 'D - 19:00' },
            { id: 'E', time: '19:10', label: 'E - 19:10' },
            { id: 'F', time: '19:20', label: 'F - 19:20' },
            { id: 'G', time: '19:30', label: 'G - 19:30' },
            { id: 'H', time: '19:40', label: 'H - 19:40' },
            { id: 'I', time: '19:50', label: 'I - 19:50' }
          ];

          const subjects = {
            "Língua Portuguesa e Redação": {
              icon: "📚",
              teachers: [
                { id: 1, name: "Profª. Juliana Tricot", turmas: ["Língua Portuguesa: 8º e 9º anos", "Redação: 9º anos"] },
                { id: 2, name: "Profª. Juliana Velho", turmas: ["Língua Portuguesa e Redação: Ensino Médio"] },
                { id: 3, name: "Profª. Daniella", turmas: ["Língua Portuguesa: 6º e 7º anos"] },
                { id: 4, name: "Profª. Márcia", turmas: ["Língua Portuguesa: 5º anos", "Inglês: 5º a 8º anos - Manhã"] }
              ]
            },
            "Matemática": {
              icon: "🧮",
              teachers: [
                { id: 5, name: "Profª. Aline", turmas: ["7º anos"] },
                { id: 6, name: "Profª Eliana", turmas: ["5º ano - Manhã"] },
                { id: 7, name: "Profª Kátya", turmas: ["2ª e 3ª séries - EM"] },
                { id: 8, name: "Prof. Mateus", turmas: ["5º anos - Tarde e 6º anos"] },
                { id: 9, name: "Profª Michele", turmas: ["8º, 9º e 1ª séries - EM"] }
              ]
            },
            "Ciências e Química": {
              icon: "🔬",
              teachers: [
                { id: 10, name: "Profª. Karina", turmas: ["Ciências: 6º, 7º, 8º e 9º"] },
                { id: 11, name: "Profª. Raquel", turmas: ["Química: 2ª e 3ª séries - EM"] },
                { id: 12, name: "Profª. Roberta", turmas: ["Ciências: 7º, 8º e 9º", "Química: 1ª série EM"] },
                { id: 13, name: "Profª. Tarine", turmas: ["Ciências: 5º anos"] }
              ]
            },
            "Espanhol": {
              icon: "🇪🇸",
              teachers: [
                { id: 14, name: "Profª. Michelle", turmas: ["6º ao 9º anos"] }
              ]
            },
            "Inglês": {
              icon: "🔤",
              teachers: [
                { id: 15, name: "Profª Bianca", turmas: ["EF2 - Tarde"] },
                { id: 16, name: "Profª Giane", turmas: ["EM"] },
                { id: 17, name: "Prof. Leonardo", turmas: ["9º anos", "EM"] }
              ]
            },
            "História/Filosofia/Sociologia": {
              icon: "🏛️",
              teachers: [
                { id: 22, name: "Prof. Cristiane", turmas: ["História e Geografia: 5º anos"] },
                { id: 23, name: "Prof. Bruno Segatto", turmas: ["História, Filosofia e Sociologia - EM"] },
                { id: 24, name: "Prof. Guilherme", turmas: ["História: 6º, 7º e 8º - Tarde"] }
              ]
            },
            "Geografia": {
              icon: "🌍",
              teachers: [
                { id: 26, name: "Prof. Dillian", turmas: ["6º ao 9º - EF", "EM"] }
              ]
            },
            "Educação Física": {
              icon: "⚽",
              teachers: [
                { id: 27, name: "Prof. Ana Carolina", turmas: ["5º ao 9º anos", "EM"] },
                { id: 28, name: "Prof. Fabiani", turmas: ["7º ao 9º anos - Manhã"] }
              ]
            }
          };

          const [currentScreen, setCurrentScreen] = useState("home");
          const [selectedSubject, setSelectedSubject] = useState("");
          const [selectedTeacher, setSelectedTeacher] = useState(null);
          const [teacherBookings, setTeacherBookings] = useState(new Map());
          const [message, setMessage] = useState("");
          const [messageType, setMessageType] = useState("");
          const [isLoading, setIsLoading] = useState(false);
          const [parentName, setParentName] = useState("");
          const [studentName, setStudentName] = useState("");
          const [email, setEmail] = useState("");
          const [selectedSlot, setSelectedSlot] = useState("");
          const [lastSync, setLastSync] = useState(null);

          const loadBookingsFromAppsScript = async () => {
            try {
              setIsLoading(true);
              const response = await fetch(APPS_SCRIPT_URL + '?t=' + Date.now());
              const result = await response.json();
              
              console.log('📥 Dados recebidos:', result);
              
              if (!result.success) throw new Error(result.error);
              
              const rows = result.data || [];
              const newBookings = new Map();
              
              rows.slice(1).forEach((row, index) => {
                if (row.length >= 6) {
                  const professor = row[0] ? row[0].toString().trim() : '';
                  const slot = row[5] ? row[5].toString().trim() : ''; // Agora é letra A-I
                  
                  console.log(`Linha ${index + 2}: Professor="${professor}", Slot="${slot}"`);
                  
                  let teacherId = null;
                  Object.values(subjects).forEach(subject => {
                    const teacher = subject.teachers.find(t => t.name === professor);
                    if (teacher) teacherId = teacher.id;
                  });
                  
                  if (teacherId && slot) {
                    if (!newBookings.has(teacherId)) {
                      newBookings.set(teacherId, new Map());
                    }
                    newBookings.get(teacherId).set(slot, {
                      parentName: row[2],
                      studentName: row[3],
                      email: row[4],
                      slot: slot,
                      bookingDate: row[6] || new Date().toLocaleDateString('pt-BR'),
                      teacher: professor,
                      subject: row[1]
                    });
                    console.log(`✅ Agendamento: ${professor} - Slot ${slot}`);
                  }
                }
              });
              
              console.log('📊 Total de professores com agendamentos:', newBookings.size);
              newBookings.forEach((bookings, teacherId) => {
                console.log(`  ID ${teacherId}: ${bookings.size} slot(s) ocupado(s) - ${Array.from(bookings.keys()).join(', ')}`);
              });
              
              setTeacherBookings(newBookings);
              setLastSync(new Date());
              showMessage('✅ Dados atualizados!', 'success');
            } catch (error) {
              console.error('❌ Erro:', error);
              showMessage('⚠️ Erro ao carregar dados', 'error');
            } finally {
              setIsLoading(false);
            }
          };

          const saveBookingToAppsScript = async (bookingData) => {
            try {
              setIsLoading(true);
              const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(bookingData)
              });
              const result = await response.json();
              return result.success;
            } catch (error) {
              console.error('Erro ao salvar:', error);
              return false;
            } finally {
              setIsLoading(false);
            }
          };

          useEffect(() => {
            loadBookingsFromAppsScript();
            
            // Atualiza automaticamente a cada 30 segundos
            const intervalId = setInterval(() => {
              loadBookingsFromAppsScript();
            }, 30000); // 30000ms = 30 segundos
            
            // Limpa o intervalo quando o componente for desmontado
            return () => clearInterval(intervalId);
          }, []);

          useEffect(() => {
            if (currentScreen === "booking" && selectedTeacher) {
              loadBookingsFromAppsScript();
            }
          }, [currentScreen, selectedTeacher]);

          const showMessage = (text, type) => {
            setMessage(text);
            setMessageType(type);
            setTimeout(() => { setMessage(""); setMessageType(""); }, 4000);
          };

          const getTeacherBookings = (teacherId) => teacherBookings.get(teacherId) || new Map();
          const isSlotAvailable = (slotId, teacherId) => {
            const bookings = getTeacherBookings(teacherId);
            const available = !bookings.has(slotId);
            console.log(`Verificando slot ${slotId} para professor ${teacherId}: ${available ? 'LIVRE' : 'OCUPADO'}`);
            return available;
          };

          const goToSubjects = () => setCurrentScreen("subjects");
          const goToTeachers = (subject) => { setSelectedSubject(subject); setCurrentScreen("teachers"); };
          const goToBooking = (teacher) => {
            setSelectedTeacher(teacher);
            setCurrentScreen("booking");
            setParentName("");
            setStudentName("");
            setEmail("");
            setSelectedSlot("");
          };
          
          const goBack = () => {
            if (currentScreen === "booking") setCurrentScreen("teachers");
            else if (currentScreen === "teachers") setCurrentScreen("subjects");
            else if (currentScreen === "subjects") setCurrentScreen("home");
          };

          const handleBooking = async () => {
            const teacherId = selectedTeacher?.id;
            if (!teacherId) return;
            
            if (!parentName.trim()) return showMessage("Insira o nome do responsável.", "error");
            if (!studentName.trim()) return showMessage("Insira o nome do estudante.", "error");
            if (!email.trim()) return showMessage("Insira o email.", "error");
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showMessage("Email inválido.", "error");
            if (!selectedSlot) return showMessage("Selecione um horário.", "error");

            await loadBookingsFromAppsScript();

            const currentBookings = getTeacherBookings(teacherId);
            if (Array.from(currentBookings.values()).find(b => b.email.toLowerCase() === email.toLowerCase())) {
              return showMessage("Este email já tem um agendamento.", "error");
            }

            if (!isSlotAvailable(selectedSlot, teacherId)) {
              return showMessage("Este horário foi reservado. Escolha outro.", "error");
            }

            const selectedSlotInfo = TIME_SLOTS.find(s => s.id === selectedSlot);
            const bookingData = {
              teacher: selectedTeacher.name,
              subject: selectedSubject,
              parentName: parentName.trim(),
              studentName: studentName.trim(),
              email: email.trim().toLowerCase(),
              slot: selectedSlot, // Salva a letra (A-I)
              time: selectedSlotInfo.time, // Salva também o horário para referência
              bookingDate: new Date().toLocaleDateString('pt-BR')
            };

            const saved = await saveBookingToAppsScript(bookingData);
            
            if (saved) {
              await loadBookingsFromAppsScript();
              showMessage('✅ Agendamento confirmado!', 'success');
              setParentName("");
              setStudentName("");
              setEmail("");
              setSelectedSlot("");
            } else {
              showMessage('❌ Erro ao salvar. Tente novamente.', 'error');
            }
          };

          if (isLoading) {
            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 flex items-center justify-center" },
              React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-8 text-center" },
                React.createElement('div', { className: "text-4xl mb-4 animate-pulse" }, "🔄"),
                React.createElement('h2', { className: "text-xl font-semibold text-gray-800" }, "Carregando..."),
              )
            );
          }

          if (currentScreen === "home") {
            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-6" },
              React.createElement('div', { className: "max-w-6xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-8 text-center" },
                  React.createElement('div', { className: "mb-8" },
                    React.createElement('div', { className: "text-6xl mb-4" }, "🎓"),
                    React.createElement('h1', { className: "text-4xl font-bold text-gray-800 mb-4" }, "Sistema de Agendamento"),
                    React.createElement('p', { className: "text-xl text-gray-600 mb-2" }, "Reuniões Pedagógicas com Professores"),
                    React.createElement('p', { className: "text-gray-500 mb-2" }, "9 horários disponíveis (A a I) - 18:30 às 19:50"),
                    React.createElement('p', { className: "text-sm text-green-600" }, "🔄 Sincronização automática ativa"),
                    lastSync && React.createElement('p', { className: "text-xs text-gray-400 mt-1" }, 
                      `Última sincronização: ${lastSync.toLocaleTimeString('pt-BR')}`
                    )
                  ),
                  React.createElement('div', { className: "flex gap-4 justify-center mb-8" },
                    React.createElement('button', {
                      onClick: goToSubjects,
                      className: "px-8 py-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-lg font-medium"
                    }, "Começar Agendamento")
                  ),
                  React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" },
                    Object.entries(subjects).map(([subject, data]) => 
                      React.createElement('div', { key: subject, className: "bg-gray-50 rounded-lg p-4" },
                        React.createElement('div', { className: "text-2xl mb-2 text-center" }, data.icon),
                        React.createElement('h3', { className: "text-sm font-semibold text-gray-800 mb-1 text-center" }, subject),
                        React.createElement('p', { className: "text-gray-600 text-xs text-center" }, `${data.teachers.length} prof(s)`)
                      )
                    )
                  ),
                  message && React.createElement('div', {
                    className: `mt-6 p-4 rounded-lg ${messageType === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`
                  }, message)
                )
              )
            );
          }

          if (currentScreen === "subjects") {
            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-6" },
              React.createElement('div', { className: "max-w-6xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-8" },
                  React.createElement('div', { className: "flex items-center mb-8" },
                    React.createElement('button', { onClick: goBack, className: "mr-4 p-2 text-gray-600 hover:text-gray-800 text-2xl" }, "←"),
                    React.createElement('h1', { className: "text-3xl font-bold text-gray-800" }, "Selecione a Disciplina")
                  ),
                  React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" },
                    Object.entries(subjects).map(([subject, data]) =>
                      React.createElement('button', {
                        key: subject,
                        onClick: () => goToTeachers(subject),
                        className: "bg-blue-50 border-2 border-blue-200 rounded-xl p-4 hover:bg-blue-100 transition-colors text-left"
                      },
                        React.createElement('div', { className: "text-3xl mb-2" }, data.icon),
                        React.createElement('h2', { className: "text-lg font-bold text-gray-800 mb-1" }, subject),
                        React.createElement('p', { className: "text-gray-600 text-sm" }, `${data.teachers.length} professores`)
                      )
                    )
                  )
                )
              )
            );
          }

          if (currentScreen === "teachers") {
            const subjectData = subjects[selectedSubject];
            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-6" },
              React.createElement('div', { className: "max-w-6xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-8" },
                  React.createElement('div', { className: "flex items-center mb-8" },
                    React.createElement('button', { onClick: goBack, className: "mr-4 p-2 text-gray-600 hover:text-gray-800 text-2xl" }, "←"),
                    React.createElement('div', { className: "text-2xl mr-3" }, subjectData.icon),
                    React.createElement('h1', { className: "text-3xl font-bold text-gray-800" }, selectedSubject)
                  ),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                    subjectData.teachers.map((teacher) => {
                      const bookingCount = getTeacherBookings(teacher.id).size;
                      return React.createElement('button', {
                        key: teacher.id,
                        onClick: () => goToBooking(teacher),
                        className: "bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-blue-300 hover:shadow-lg transition-all text-left"
                      },
                        React.createElement('h3', { className: "text-base font-bold text-gray-800 mb-2" }, teacher.name),
                        React.createElement('p', { className: "text-xs text-gray-600 mb-2" }, "Turmas:"),
                        React.createElement('div', { className: "flex flex-wrap gap-1 mb-2" },
                          teacher.turmas.slice(0, 2).map((turma, i) =>
                            React.createElement('span', { key: i, className: "px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full" }, turma)
                          )
                        ),
                        React.createElement('p', { className: "text-xs text-gray-500" }, `${TIME_SLOTS.length - bookingCount} horários disponíveis`)
                      );
                    })
                  )
                )
              )
            );
          }

          if (currentScreen === "booking") {
            const teacherBookingsData = getTeacherBookings(selectedTeacher.id);
            const existingBooking = email ? Array.from(teacherBookingsData.values()).find(b => b.email.toLowerCase() === email.toLowerCase()) : null;
            const availableCount = TIME_SLOTS.filter(slot => isSlotAvailable(slot.id, selectedTeacher.id)).length;
            
            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6" },
              React.createElement('div', { className: "max-w-4xl mx-auto" },
                React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-8" },
                  React.createElement('div', { className: "flex items-center mb-8" },
                    React.createElement('button', { onClick: goBack, className: "mr-4 p-2 text-gray-600 hover:text-gray-800 text-2xl" }, "←"),
                    React.createElement('div', { className: "flex-1" },
                      React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-2" }, selectedTeacher.name),
                      React.createElement('p', { className: "text-gray-600" }, `📚 ${selectedSubject}`)
                    )
                  ),
                  React.createElement('div', { className: "grid grid-cols-3 gap-4 mb-8" },
                    React.createElement('div', { className: "bg-blue-50 rounded-lg p-4 text-center" },
                      React.createElement('div', { className: "text-2xl font-bold text-blue-600" }, TIME_SLOTS.length),
                      React.createElement('div', { className: "text-sm text-gray-600" }, "Total")
                    ),
                    React.createElement('div', { className: "bg-green-50 rounded-lg p-4 text-center" },
                      React.createElement('div', { className: "text-2xl font-bold text-green-600" }, availableCount),
                      React.createElement('div', { className: "text-sm text-gray-600" }, "Disponíveis")
                    ),
                    React.createElement('div', { className: "bg-red-50 rounded-lg p-4 text-center" },
                      React.createElement('div', { className: "text-2xl font-bold text-red-600" }, teacherBookingsData.size),
                      React.createElement('div', { className: "text-sm text-gray-600" }, "Ocupados")
                    )
                  ),
                  React.createElement('div', { className: "bg-gray-50 rounded-lg p-6 mb-8" },
                    React.createElement('h2', { className: "text-xl font-semibold mb-4" }, "⏰ Fazer Agendamento"),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" },
                      React.createElement('input', {
                        type: "text",
                        value: parentName,
                        onChange: (e) => setParentName(e.target.value),
                        placeholder: "Nome do responsável *",
                        className: "px-4 py-2 border border-gray-300 rounded-lg"
                      }),
                      React.createElement('input', {
                        type: "text",
                        value: studentName,
                        onChange: (e) => setStudentName(e.target.value),
                        placeholder: "Nome do estudante *",
                        className: "px-4 py-2 border border-gray-300 rounded-lg"
                      }),
                      React.createElement('input', {
                        type: "email",
                        value: email,
                        onChange: (e) => setEmail(e.target.value),
                        placeholder: "Email *",
                        className: "px-4 py-2 border border-gray-300 rounded-lg"
                      }),
                      React.createElement('select', {
                        value: selectedSlot,
                        onChange: (e) => setSelectedSlot(e.target.value),
                        className: "px-4 py-2 border border-gray-300 rounded-lg"
                      },
                        React.createElement('option', { value: "" }, "Selecione um horário"),
                        TIME_SLOTS.map((slot) => {
                          const available = isSlotAvailable(slot.id, selectedTeacher.id);
                          return React.createElement('option', {
                            key: slot.id,
                            value: slot.id,
                            disabled: !available
                          }, `${slot.label} ${!available ? "(Ocupado)" : ""}`);
                        })
                      )
                    ),
                    existingBooking && React.createElement('p', { className: "text-sm text-amber-600 mb-4" }, 
                      `⚠️ Email já tem agendamento no horário ${existingBooking.slot}`
                    ),
                    React.createElement('button', {
                      onClick: handleBooking,
                      disabled: !parentName.trim() || !studentName.trim() || !email.trim() || !selectedSlot || existingBooking,
                      className: "px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 font-medium w-full"
                    }, "Confirmar Agendamento")
                  ),
                  message && React.createElement('div', {
                    className: `mb-6 p-4 rounded-lg ${messageType === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`
                  }, message),
                  React.createElement('div', {},
                    React.createElement('h3', { className: "text-xl font-semibold mb-4" }, "Horários Disponíveis"),
                    React.createElement('div', { className: "grid grid-cols-3 md:grid-cols-3 gap-3" },
                      TIME_SLOTS.map((slot) => {
                        const available = isSlotAvailable(slot.id, selectedTeacher.id);
                        return React.createElement('div', {
                          key: slot.id,
                          className: `p-4 rounded-lg text-center font-medium border-2 ${
                            available ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'
                          }`
                        },
                          React.createElement('div', { className: "text-2xl font-bold mb-1" }, slot.id),
                          React.createElement('div', { className: "text-sm" }, slot.time),
                          React.createElement('div', { className: "text-xs mt-1" }, available ? 'Livre' : 'Ocupado')
                        );
                      })
                    )
                  )
                )
              )
            );
          }

          return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TeacherSchedulingSystem));
    </script>
</body>
</html>
