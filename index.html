<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Agendamento - Professores</title>

  <!-- React UMD + Babel (para facilitar testes locais sem build) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;

  // ======= ATEN√á√ÉO: substitua pela URL do seu Web App do Google Apps Script (termina em /exec)
  const APPS_SCRIPT_URL = "SUA_URL_DO_APPS_SCRIPT_AQUI";
  const ADMIN_PASSWORD = "admin123";

  // ============================
  // Mat√©rias / Professores (configura√ß√£o)
  // (mantive a sua lista original ‚Äî ajuste se quiser)
  // ============================
  const subjects = {
    "L√≠ngua Portuguesa e Reda√ß√£o": {
      icon: "üìö",
      color: "blue",
      teachers: [
        { id: 1, name: "Prof¬™. Juliana Tricot", turmas: ["L√≠ngua Portuguesa: 8¬∫ e 9¬∫ anos", "Reda√ß√£o: 9¬∫ anos"] },
        { id: 2, name: "Prof¬™. Juliana Velho", turmas: ["L√≠ngua Portuguesa e Reda√ß√£o: Ensino M√©dio"] },
        { id: 3, name: "Prof¬™. Daniella", turmas: ["L√≠ngua Portuguesa: 6¬∫ e 7¬∫ anos"] },
        { id: 4, name: "Prof¬™. M√°rcia", turmas: ["L√≠ngua Portuguesa: 5¬∫ anos", "Ingl√™s: 5¬∫ anos a 8¬∫ anos - Manh√£"] }
      ]
    },
    "Matem√°tica": {
      icon: "üßÆ",
      color: "green",
      teachers: [
        { id: 5, name: "Prof¬™. Aline", turmas: ["7¬∫ anos"] },
        { id: 6, name: "Prof¬™ Eliana", turmas: ["5¬∫ ano - Manh√£"] },
        { id: 7, name: "Prof¬™ K√°tya", turmas: ["2¬™ e 3¬™ s√©ries - EM"] },
        { id: 8, name: "Prof. Mateus", turmas: ["5¬∫ anos - Tarde e 6¬∫ anos"] },
        { id: 9, name: "Prof¬™ Michele", turmas: ["8¬∫, 9¬∫ e 1¬™ s√©ries - EM"] }
      ]
    },
    "Ci√™ncias e Qu√≠mica": {
      icon: "üî¨",
      color: "purple",
      teachers: [
        { id: 10, name: "Prof¬™. Karina", turmas: ["Ci√™ncias: 6¬∫, Manh√£ e Tarde, 7¬∫, 8¬∫ e 9¬∫ - Tarde"] },
        { id: 11, name: "Prof¬™. Raquel", turmas: ["Qu√≠mica: 2¬™ e 3¬™ s√©ries - EM"] },
        { id: 12, name: "Prof¬™. Roberta", turmas: ["Ci√™ncias: 7¬∫, 8¬∫ e 9¬∫ - Manh√£", "Qu√≠mica: 1¬™ s√©rie: EM"] },
        { id: 13, name: "Prof¬™. Tarine", turmas: ["Ci√™ncias: 5¬∫ anos"] }
      ]
    },
    "Espanhol": {
      icon: "üá™üá∏",
      color: "red",
      teachers: [
        { id: 14, name: "Prof¬™. Michelle", turmas: ["6¬∫ ao 9¬∫ anos"] }
      ]
    },
    "Ingl√™s": {
      icon: "üî§",
      color: "indigo",
      teachers: [
        { id: 15, name: "Prof¬™ Bianca", turmas: ["EF2 - Tarde"] },
        { id: 16, name: "Prof¬™ Giane", turmas: ["EM"] },
        { id: 17, name: "Prof. Leonardo", turmas: ["9¬∫ anos", "EM"] },
        { id: 18, name: "Prof. Everton", turmas: ["EM"] },
        { id: 19, name: "Prof. Patrick", turmas: ["EM"] },
        { id: 20, name: "Prof¬™ Regina", turmas: ["EM"] },
        { id: 21, name: "Prof¬™ Gisele", turmas: ["EM"] }
      ]
    },
    "Hist√≥ria/Filosofia/Sociologia": {
      icon: "üèõÔ∏è",
      color: "yellow",
      teachers: [
        { id: 22, name: "Prof. Cristiane", turmas: ["Hist√≥ria e Geografia: 5¬∫ anos", "Hist√≥ria: 6¬∫ - Manh√£", "Ensino Religiosos"] },
        { id: 23, name: "Prof. Bruno Segatto", turmas: ["Hist√≥ria - EM", "Filosofia - EM", "Sociologia - EM"] },
        { id: 24, name: "Prof. Guilherme", turmas: ["Hist√≥ria: 6¬∫, 7¬∫ e 8¬∫ - Tarde", "Filosofia: 8¬∫ - Tarde"] },
        { id: 25, name: "Prof¬™. Isadora", turmas: ["Hist√≥ria - 7¬∫, 8¬∫ - Manh√£, 9¬∫ anos", "Filosofia: 8¬∫ - Manh√£ e 9¬∫"] }
      ]
    },
    "Geografia": {
      icon: "üåç",
      color: "teal",
      teachers: [
        { id: 26, name: "Prof. Dillian", turmas: ["6¬∫ ao 9¬∫ - EF", "EM"] }
      ]
    },
    "Educa√ß√£o F√≠sica": {
      icon: "‚öΩ",
      color: "orange",
      teachers: [
        { id: 27, name: "Prof. Ana Carolina", turmas: ["5¬∫ ao 9¬∫ anos", "EM"] },
        { id: 28, name: "Prof. Fabiani", turmas: ["7¬∫ ao 9¬∫ anos- Manh√£"] }
      ]
    }
  };

  // ============================
  // Gera√ß√£o de hor√°rios (18:30 a 19:50, intervalos de 10 min)
  // ============================
  const generateTimeSlots = () => {
    const slots = [];
    const today = new Date();
    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 18, 30, 0, 0);
    const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 19, 50, 0, 0);

    let cur = new Date(startTime);
    while (cur <= endTime) {
      const hh = String(cur.getHours()).padStart(2, "0");
      const mm = String(cur.getMinutes()).padStart(2, "0");
      slots.push(`${hh}:${mm}`);
      cur.setMinutes(cur.getMinutes() + 10);
    }
    return slots;
  };
  const timeSlots = generateTimeSlots();

  // ============================
  // Component
  // ============================
  function TeacherSchedulingSystem() {
    // estados
    const [currentScreen, setCurrentScreen] = useState("home");
    const [selectedSubject, setSelectedSubject] = useState("");
    const [selectedTeacher, setSelectedTeacher] = useState(null);
    const [teacherBookings, setTeacherBookings] = useState(new Map()); // Map<teacherId, Map<time, bookingData>>
    const [message, setMessage] = useState("");
    const [messageType, setMessageType] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    const [adminPassword, setAdminPassword] = useState("");
    const [parentName, setParentName] = useState("");
    const [studentName, setStudentName] = useState("");
    const [email, setEmail] = useState("");
    const [selectedSlot, setSelectedSlot] = useState("");
    const [adminData, setAdminData] = useState([]);

    // mensagens
    const showMessage = (text, type="success") => {
      setMessage(text);
      setMessageType(type);
      setTimeout(() => { setMessage(""); setMessageType(""); }, 4500);
    };

    // ============================
    // Backend: carregar agendamentos (doGet)
    // ============================
    const loadBookingsFromAppsScript = async () => {
      try {
        setIsLoading(true);
        const resp = await fetch(APPS_SCRIPT_URL);
        const json = await resp.json();
        if (!json.success) throw new Error(json.error || "Erro ao carregar");

        const rows = json.data || [];
        const bookingRows = rows.slice(1); // pular cabe√ßalho
        const newBookings = new Map();
        const allBookings = [];

        bookingRows.forEach(row => {
          // row expected: [Professor, Disciplina, Respons√°vel, Estudante, Email, Hor√°rio, Data]
          if (!row || row.length < 6) return;
          const [professor, disciplina, responsavel, estudante, emailResp, horario, data] = row;
          // encontrar id do professor
          let teacherId = null;
          Object.values(subjects).forEach(sub => {
            const t = sub.teachers.find(tt => tt.name === professor);
            if (t) teacherId = t.id;
          });
          if (!teacherId) return;
          if (!newBookings.has(teacherId)) newBookings.set(teacherId, new Map());
          const bookingData = {
            teacher: professor,
            subject: disciplina,
            parentName: responsavel,
            studentName: estudante,
            email: emailResp,
            time: horario,
            bookingDate: data || new Date().toLocaleDateString("pt-BR")
          };
          newBookings.get(teacherId).set(horario, bookingData);
          allBookings.push(bookingData);
        });

        setTeacherBookings(newBookings);
        setAdminData(allBookings);
      } catch (err) {
        console.error("Erro ao carregar agendamentos:", err);
        showMessage("Erro ao conectar com a planilha.", "error");
      } finally {
        setIsLoading(false);
      }
    };

    // ============================
    // Backend: salvar agendamento (doPost)
    // Assumimos que o Apps Script retorna {success:true} ou {success:false, error: "..."}
    // ============================
    const saveBookingToAppsScript = async (bookingData) => {
      try {
        setIsLoading(true);
        const resp = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bookingData)
        });

        // tenta ler JSON (assume CORS ok). Se ocorrer erro de CORS, this will throw.
        const json = await resp.json();
        if (!json.success) return { error: json.error || "Erro no servidor" };
        return true;
      } catch (err) {
        console.error("Erro ao salvar:", err);
        // Se quiser suprimir e assumir que salvou (modo no-cors), trocar l√≥gica aqui.
        return { error: err.message || "Erro de rede" };
      } finally {
        setIsLoading(false);
      }
    };

    // ============================
    // L√≥gica de agendamento no front
    // ============================
    const getTeacherBookings = (teacherId) => teacherBookings.get(teacherId) || new Map();
    const getBookedSlots = (teacherId) => new Set(Array.from(getTeacherBookings(teacherId).keys()));
    const isSlotAvailable = (slot, teacherId) => !getBookedSlots(teacherId).has(slot);

    const handleBooking = async () => {
      const teacherId = selectedTeacher?.id;
      if (!teacherId || !parentName.trim() || !studentName.trim() || !email.trim() || !selectedSlot) {
        showMessage("Por favor, preencha todos os campos.", "error");
        return;
      }
      // email b√°sico
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showMessage("Por favor, insira um email v√°lido.", "error");
        return;
      }

      // checar no front rapidamente (evita requisi√ß√£o se j√° ocup.)
      if (!isSlotAvailable(selectedSlot, teacherId)) {
        showMessage("Este hor√°rio j√° est√° ocupado. Escolha outro.", "error");
        return;
      }

      const bookingData = {
        teacher: selectedTeacher.name,
        subject: selectedSubject,
        parentName: parentName.trim(),
        studentName: studentName.trim(),
        email: email.trim().toLowerCase(),
        time: selectedSlot,
        bookingDate: new Date().toLocaleDateString("pt-BR")
      };

      const saved = await saveBookingToAppsScript(bookingData);

      if (saved === true) {
        showMessage(`Agendamento confirmado para ${selectedTeacher.name} √†s ${selectedSlot}!`, "success");
        // atualizar localmente para bloquear o hor√°rio imediatamente
        setTeacherBookings(prev => {
          const next = new Map(prev);
          const mapForTeacher = new Map(next.get(teacherId) || []);
          mapForTeacher.set(selectedSlot, bookingData);
          next.set(teacherId, mapForTeacher);
          return next;
        });
        // atualizar adminData tamb√©m
        setAdminData(prev => [ ...prev, bookingData ]);
        // limpar e voltar
        setTimeout(() => {
          setParentName(""); setStudentName(""); setEmail(""); setSelectedSlot("");
          setCurrentScreen("home");
        }, 1200);
      } else if (saved && saved.error === "Hor√°rio j√° ocupado para este professor.") {
        // servidor negou por duplicidade
        showMessage("‚ùå Este hor√°rio acabou de ser reservado por outra pessoa. Por favor, escolha outro.", "error");
        await loadBookingsFromAppsScript(); // recarrega do servidor para atualizar status
      } else {
        // erro de rede / servidor
        showMessage("‚ö†Ô∏è Erro ao salvar. Tente novamente.", "error");
      }
    };

    // carregar ao iniciar
    useEffect(() => {
      // s√≥ carrega se a URL do script estiver configurada
      if (APPS_SCRIPT_URL && !APPS_SCRIPT_URL.includes("SUA_URL")) {
        loadBookingsFromAppsScript();
        // descomente se quiser refresh autom√°tico:
        // const interval = setInterval(loadBookingsFromAppsScript, 60000);
        // return () => clearInterval(interval);
      }
    }, []);

    // admin: ao entrar, carregar dados
    const enterAdmin = async () => {
      if (adminPassword === ADMIN_PASSWORD) {
        setAdminPassword("");
        setCurrentScreen("adminPanel");
        showMessage("Acesso administrativo concedido!", "success");
        await loadBookingsFromAppsScript();
      } else {
        showMessage("Senha incorreta.", "error");
      }
    };

    // pequenas UIs
    const MessageComponent = ({ message, type }) => (
      message ? (
        <div className={`mt-6 p-3 rounded text-center text-sm ${type === "success" ? "bg-green-50 text-green-800 border border-green-200" : "bg-red-50 text-red-800 border border-red-200"}`}>
          {message}
        </div>
      ) : null
    );

    // render principal
    const renderScreen = () => {
      if (isLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="bg-white p-8 rounded-xl shadow text-center">
              <div className="text-4xl mb-4 animate-spin">‚è≥</div>
              <div>Sincronizando com a planilha...</div>
            </div>
          </div>
        );
      }

      if (currentScreen === "home") {
        return (
          <div className="p-6 max-w-6xl mx-auto">
            <div className="bg-white rounded-2xl shadow p-8 text-center">
              <div className="text-6xl mb-2">üéì</div>
              <h1 className="text-3xl font-bold mb-2">Sistema de Agendamento</h1>
              <p className="text-gray-600 mb-4">Reuni√µes Pedag√≥gicas ‚Äî Hor√°rios: 18:30 √†s 19:50 (10 min)</p>

              <div className="flex justify-center gap-4 mb-6">
                <button onClick={() => setCurrentScreen("subjects")} className="px-6 py-3 bg-indigo-600 text-white rounded-lg">Come√ßar Agendamento</button>
                <button onClick={() => setCurrentScreen("admin")} className="px-6 py-3 bg-gray-600 text-white rounded-lg">√Årea Administrativa</button>
                <button onClick={loadBookingsFromAppsScript} className="px-6 py-3 bg-green-600 text-white rounded-lg">üîÑ Atualizar</button>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {Object.entries(subjects).map(([subject, data]) => (
                  <div key={subject} className="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <div className="text-2xl mb-2 text-center">{data.icon}</div>
                    <div className="text-sm font-semibold text-gray-800 text-center">{subject}</div>
                    <div className="text-xs text-gray-500 text-center mt-1">{data.teachers.length} prof(s)</div>
                  </div>
                ))}
              </div>

              <MessageComponent message={message} type={messageType} />
            </div>
          </div>
        );
      }

      if (currentScreen === "subjects") {
        return (
          <div className="p-6 max-w-4xl mx-auto">
            <button onClick={() => setCurrentScreen("home")} className="mb-4 text-gray-600">‚Üê Voltar</button>
            <h2 className="text-2xl font-bold mb-6 text-center">1. Selecione a Mat√©ria</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {Object.entries(subjects).map(([subject, data]) => (
                <button key={subject} onClick={() => { setSelectedSubject(subject); setCurrentScreen("teachers"); }} className="bg-white rounded-xl p-4 shadow hover:shadow-lg text-left">
                  <div className="text-3xl mb-2">{data.icon}</div>
                  <div className="font-semibold text-gray-800">{subject}</div>
                  <div className="text-xs text-gray-500 mt-1">{data.teachers.length} professor(es)</div>
                </button>
              ))}
            </div>
          </div>
        );
      }

      if (currentScreen === "teachers") {
        const teachers = subjects[selectedSubject]?.teachers || [];
        return (
          <div className="p-6 max-w-4xl mx-auto">
            <button onClick={() => setCurrentScreen("subjects")} className="mb-4 text-gray-600">‚Üê Voltar</button>
            <h2 className="text-2xl font-bold mb-4 text-center">2. Selecione o Professor</h2>
            <p className="text-center text-gray-600 mb-4">Mat√©ria: <span className="font-semibold">{selectedSubject}</span></p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {teachers.map(t => {
                const bookedCount = getBookedSlots(t.id).size;
                const available = timeSlots.length - bookedCount;
                return (
                  <div key={t.id} className="bg-white p-4 rounded-lg shadow">
                    <div className="flex justify-between items-center mb-2">
                      <div>
                        <h3 className="font-semibold">{t.name}</h3>
                        <div className="text-xs text-gray-500">{t.turmas.join(", ")}</div>
                      </div>
                      <div className="text-sm text-green-600">{available} dispon√≠veis</div>
                    </div>
                    <button onClick={() => { setSelectedTeacher(t); setCurrentScreen("booking"); }} className="w-full py-2 bg-indigo-600 text-white rounded-lg">Agendar</button>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      if (currentScreen === "booking") {
        const bookedSlots = getBookedSlots(selectedTeacher.id);
        return (
          <div className="p-6 max-w-2xl mx-auto">
            <button onClick={() => setCurrentScreen("teachers")} className="mb-4 text-gray-600">‚Üê Voltar</button>
            <div className="bg-white p-6 rounded-lg shadow">
              <h2 className="font-bold text-xl mb-2 text-center">Agendar com {selectedTeacher.name}</h2>
              <p className="text-sm text-gray-600 mb-4 text-center">Mat√©ria: {selectedSubject}</p>

              <div className="mb-4 grid grid-cols-3 gap-2">
                {timeSlots.map(slot => (
                  <button
                    key={slot}
                    onClick={() => setSelectedSlot(slot)}
                    disabled={!isSlotAvailable(slot, selectedTeacher.id)}
                    className={`p-2 rounded text-sm ${selectedSlot === slot ? "bg-indigo-600 text-white" : isSlotAvailable(slot, selectedTeacher.id) ? "bg-indigo-100 text-indigo-800 hover:bg-indigo-200" : "bg-gray-200 text-gray-500 line-through"}`}
                  >
                    {slot}
                  </button>
                ))}
              </div>

              <div className="mb-3">
                <input value={parentName} onChange={(e) => setParentName(e.target.value)} placeholder="Nome do respons√°vel" className="w-full p-2 border rounded" />
              </div>
              <div className="mb-3">
                <input value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="Nome do estudante" className="w-full p-2 border rounded" />
              </div>
              <div className="mb-4">
                <input value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email para contato" className="w-full p-2 border rounded" />
              </div>

              <button onClick={handleBooking} className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold">Confirmar Agendamento</button>

              <MessageComponent message={message} type={messageType} />
            </div>
          </div>
        );
      }

      if (currentScreen === "admin") {
        return (
          <div className="p-6 max-w-sm mx-auto">
            <button onClick={() => setCurrentScreen("home")} className="mb-4 text-gray-600">‚Üê Voltar</button>
            <div className="bg-white p-6 rounded shadow">
              <h3 className="text-lg font-semibold mb-3">√Årea Administrativa</h3>
              <input value={adminPassword} onChange={(e) => setAdminPassword(e.target.value)} placeholder="Senha de administrador" type="password" className="w-full p-2 border rounded mb-3" />
              <button onClick={enterAdmin} className="w-full py-2 bg-gray-700 text-white rounded">Entrar</button>
              <MessageComponent message={message} type={messageType} />
            </div>
          </div>
        );
      }

      if (currentScreen === "adminPanel") {
        return (
          <div className="p-6 max-w-6xl mx-auto">
            <button onClick={() => setCurrentScreen("home")} className="mb-4 text-gray-600">‚Üê Voltar</button>
            <div className="bg-white p-6 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4">Painel Administrativo</h3>

              {adminData.length ? (
                <div className="overflow-x-auto">
                  <table className="min-w-full table-auto border-collapse">
                    <thead>
                      <tr className="bg-gray-100 text-left">
                        <th className="p-2">Professor</th>
                        <th className="p-2">Disciplina</th>
                        <th className="p-2">Hor√°rio</th>
                        <th className="p-2">Respons√°vel</th>
                        <th className="p-2">Estudante</th>
                        <th className="p-2">Email</th>
                      </tr>
                    </thead>
                    <tbody>
                      {adminData.map((b, i) => (
                        <tr key={i} className="border-t">
                          <td className="p-2">{b.teacher}</td>
                          <td className="p-2">{b.subject}</td>
                          <td className="p-2 font-semibold">{b.time}</td>
                          <td className="p-2">{b.parentName}</td>
                          <td className="p-2">{b.studentName}</td>
                          <td className="p-2 text-blue-600">{b.email}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center text-gray-500 py-8">Nenhum agendamento encontrado.</div>
              )}
            </div>
          </div>
        );
      }

      return <div className="p-6">Tela n√£o encontrada</div>;
    };

    return <div className="min-h-screen flex items-center justify-center p-4">{renderScreen()}</div>;
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<TeacherSchedulingSystem />);
  </script>
</body>
</html>

